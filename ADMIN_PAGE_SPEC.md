# 管理者ページ仕様書

## 概要

`http://localhost:3010/admin` は、**お茶診断AIシステムのRAG知識ベースを管理するための管理者専用ページ**です。

### 目的
- お茶の専門知識をRAG（Retrieval-Augmented Generation）システムに登録・管理
- 学習済み記事と抽出された知識の確認
- 知識ベースの統計情報と学習履歴の確認

---

## ページ構成

### 1. メインページ `/admin`

#### 1.1 ヘッダー
- **タイトル**: 「RAG知識ベース管理」
- **サブタイトル**: 「お茶の専門知識を管理・学習履歴を確認」
- **アクションボタン**: 「ホームに戻る」ボタン（オレンジ色）

#### 1.2 タブナビゲーション
4つのタブで構成されています：

1. **知識ベース** (`knowledge`)
   - 登録されている知識エントリの一覧を表示
   - 各エントリには以下が含まれます：
     - 条件・状況（例：「疲労回復」「ストレス解消」）
     - おすすめのお茶の種類とブレンド
     - 甘味料・お茶菓子の提案
     - 理由（なぜこのお茶がおすすめか）
     - 出典（元記事のタイトル）
     - 信頼度スコア（70%または90%）
   - 件数表示: `知識ベース (X)` の形式

2. **学習記事一覧** (`/admin/articles`)
   - 別ページに遷移
   - 学習済み記事の一覧を表示
   - 各記事から抽出された知識も確認可能

3. **学習履歴** (`history`)
   - 最近の学習活動を表示
   - 記事学習完了の履歴
   - 知識ベース更新の履歴
   - 最終更新日時の表示
   - 件数表示: `学習履歴 (X)` の形式

4. **統計情報** (`stats`)
   - 記事数（学習済み記事の総数）
   - 知識エントリ数（抽出された知識の総数）
   - 最終更新日時
   - 知識ベースの状況（カテゴリ別の件数）
     - 疲労回復関連
     - ストレス解消関連
     - 風邪予防関連
     - 美肌効果関連
     - 消化促進関連
     - リラックス関連

---

### 2. 学習記事一覧ページ `/admin/articles`

#### 機能
- **学習済み記事の一覧表示**
  - 記事タイトル
  - カテゴリ（健康、ライフスタイル、レシピ、文化）
  - 学習日時
  - 公開日（あれば）
  - タグ
  - 記事内容のプレビュー（最初の200文字）

- **記事詳細モーダル**
  - 記事をクリックすると詳細モーダルが表示
  - 記事情報（カテゴリ、学習日、公開日、タグ）
  - 記事の全文表示
  - **抽出された知識の表示**
    - その記事からAIが抽出した知識エントリを一覧表示
    - 各知識エントリには以下が含まれます：
      - 条件・状況
      - おすすめのお茶
      - ブレンド情報
      - 甘味料・お茶菓子
      - 理由

#### アクションボタン
- **記事を追加**: `/admin/upload` に遷移
- **管理画面に戻る**: `/admin` に戻る

---

### 3. 記事アップロードページ `/admin/upload`（別ページ）

#### 機能
- 新しい記事をアップロードして学習させる
- 複数の記事を同時にアップロード可能
- 各記事から知識を抽出してRAG知識ベースに追加

---

## データフロー

### データ取得
1. **APIエンドポイント**: `/api/supabase-upload` (GET)
   - 統計情報と知識エントリの一覧を取得
   - Supabaseの `tea_articles` と `tea_knowledge_entries` テーブルから取得

2. **APIエンドポイント**: `/api/articles` (GET)
   - 記事一覧を取得
   - Supabaseの `tea_articles` テーブルから取得

3. **APIエンドポイント**: `/api/articles/[id]` (GET)
   - 特定の記事の詳細と抽出された知識を取得

### セキュリティ
- **サービスロールキー使用**: 管理画面用のAPIは `SUPABASE_SERVICE_ROLE_KEY` を使用
  - RLS（Row Level Security）をバイパスしてデータにアクセス可能
  - 通常のユーザー向けAPIは `NEXT_PUBLIC_SUPABASE_ANON_KEY` を使用

---

## 技術仕様

### データベーステーブル

1. **`tea_articles`**
   - 学習済みの記事を保存
   - カラム: `id`, `title`, `content`, `category`, `tags`, `publish_date`, `created_at`, `updated_at`, `embedding`

2. **`tea_knowledge_entries`**
   - 記事から抽出された知識を保存
   - カラム: `id`, `condition`, `tea`, `blend`, `sweetener`, `snack`, `reason`, `source`, `created_at`, `updated_at`

### データ型変換
- **`tags` フィールド**: データベースから取得した値が配列でない場合、自動的に配列に変換
  - 文字列の場合はカンマで分割
  - それ以外の場合は空配列に設定

---

## 使用ユーザー

### 管理者
- お茶の専門知識をシステムに登録する担当者
- 記事をアップロードして学習させる担当者
- 知識ベースの状態を確認・監視する担当者

### アクセス制限
- 現在は認証機能が実装されていないため、URLを知っている人は誰でもアクセス可能
- 本番環境では認証機能の実装を推奨

---

## 主な機能の流れ

### 1. 記事を学習させる流れ
1. `/admin/upload` で記事をアップロード
2. AIが記事から知識を抽出
3. 抽出された知識が `tea_knowledge_entries` テーブルに保存
4. `/admin` の「知識ベース」タブで確認可能

### 2. 知識ベースの確認
1. `/admin` にアクセス
2. 「知識ベース」タブで抽出された知識を確認
3. 「統計情報」タブで全体の状況を把握

### 3. 学習済み記事の確認
1. `/admin/articles` にアクセス
2. 学習済み記事の一覧を確認
3. 各記事をクリックして、抽出された知識を確認

---

## 注意事項

1. **認証機能**: 現在認証機能が実装されていないため、本番環境では追加が必要
2. **データベースアクセス**: サービスロールキーを使用しているため、RLSをバイパスしてアクセス可能
3. **エラーハンドリング**: APIエラー時は適切なエラーメッセージを表示

---

## 関連ファイル

- `src/app/admin/page.tsx` - メイン管理者ページ
- `src/app/admin/articles/page.tsx` - 学習記事一覧ページ
- `src/app/admin/upload/page.tsx` - 記事アップロードページ
- `src/lib/supabase-knowledge-base.ts` - 知識ベース管理クラス
- `src/lib/supabase.ts` - Supabaseクライアント設定
- `src/app/api/supabase-upload/route.ts` - 統計情報取得API
- `src/app/api/articles/route.ts` - 記事一覧取得API
- `src/app/api/articles/[id]/route.ts` - 記事詳細取得API



