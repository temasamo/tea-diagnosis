name: Sync RAG Articles (HealTea + MarketSupporterAI)

on:
  schedule:
    # æ¯Žæ—¥ åˆå‰3æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•å®Ÿè¡Œï¼ˆUTCæ›ç®—ã§18:00ï¼‰
    - cron: "0 18 * * *"
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout tea-diagnosis repository
        uses: actions/checkout@v4
        with:
          path: tea-diagnosis

      - name: ðŸ“¦ Checkout HealTea repository
        uses: actions/checkout@v4
        with:
          repository: temasamo/healtea-blog  # å®Ÿéš›ã®ãƒªãƒã‚¸ãƒˆãƒªåã«å¤‰æ›´ã—ã¦ãã ã•ã„
          path: HealTea-Project
          token: ${{ secrets.GITHUB_TOKEN }}  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã¯PATãŒå¿…è¦

      - name: ðŸ“¦ Checkout Affiliate repository
        uses: actions/checkout@v4
        with:
          repository: temasamo/affiliate-blog  # å®Ÿéš›ã®ãƒªãƒã‚¸ãƒˆãƒªåã«å¤‰æ›´ã—ã¦ãã ã•ã„
          path: Affiliate-Project
          token: ${{ secrets.GITHUB_TOKEN }}  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã¯PATãŒå¿…è¦

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install dependencies
        working-directory: tea-diagnosis
        run: npm ci

      - name: ðŸ“¦ Install tsx (if not in package.json)
        working-directory: tea-diagnosis
        run: npm install --save-dev tsx || true

      - name: ðŸ”‘ Load environment variables
        working-directory: tea-diagnosis
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}" >> .env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}" >> .env.local
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env.local

      - name: ðŸš€ Sync HealTea Articles
        working-directory: tea-diagnosis
        env:
          HEALTEA_ARTICLES_DIR: ${{ github.workspace }}/HealTea-Project/healtea-blog/src/content/blog/health/tea/blendedtea
        run: npx tsx src/scripts/syncHealteaArticles.ts
        continue-on-error: true  # ä¸€æ–¹ãŒå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ

      - name: ðŸš€ Sync MarketSupporterAI Articles
        working-directory: tea-diagnosis
        env:
          AFFILIATE_ARTICLES_DIR: ${{ github.workspace }}/Affiliate-Project/affiliate-blog/articles/japanesetea
        run: npx tsx src/scripts/syncAffiliateArticles.ts
        continue-on-error: true  # ä¸€æ–¹ãŒå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## RAGåŒæœŸçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- HealTeaè¨˜äº‹åŒæœŸ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- MarketSupporterAIè¨˜äº‹åŒæœŸ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

