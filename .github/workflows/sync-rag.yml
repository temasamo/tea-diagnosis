name: ðŸ”„ Sync RAG Articles (HealTea + MarketSupporterAI)

on:
  schedule:
    # æ¯Žæ—¥ åˆå‰3æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•å®Ÿè¡Œï¼ˆUTCæ›ç®—ã§18:00ï¼‰
    - cron: "0 18 * * *"
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout tea-diagnosis repository
        uses: actions/checkout@v4
        with:
          path: tea-diagnosis

      - name: ðŸ“¦ Checkout HealTea repository
        uses: actions/checkout@v4
        with:
          repository: temasamo/healtea-blog
          path: HealTea-Project
          token: ${{ secrets.PAT_TOKEN }}  # â† PATã«å¤‰æ›´ï¼ˆå¿…é ˆï¼‰

      - name: ðŸ“¦ Checkout Affiliate repository
        uses: actions/checkout@v4
        with:
          repository: temasamo/affiliate-blog
          path: Affiliate-Project
          token: ${{ secrets.PAT_TOKEN }}  # â† åŒã˜ãPATã§èªè¨¼

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ðŸ“¦ Install dependencies
        working-directory: tea-diagnosis
        run: pnpm install --frozen-lockfile

      - name: ðŸ”‘ Load environment variables
        working-directory: tea-diagnosis
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}" >> .env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}" >> .env.local
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env.local

      - name: ðŸš€ Sync HealTea Articles
        working-directory: tea-diagnosis
        env:
          HEALTEA_ARTICLES_DIR: ${{ github.workspace }}/HealTea-Project/healtea-blog/src/content/blog/health/tea/blendedtea
        run: pnpm run sync:healtea
        continue-on-error: true  # HealTeaåŒæœŸå¤±æ•—ã§ã‚‚ç¶šè¡Œ

      - name: ðŸš€ Sync MarketSupporterAI Articles
        working-directory: tea-diagnosis
        env:
          AFFILIATE_ARTICLES_DIR: ${{ github.workspace }}/Affiliate-Project/articles/japanesetea
        run: pnpm run sync:affiliate
        continue-on-error: true  # AffiliateåŒæœŸå¤±æ•—ã§ã‚‚ç¶šè¡Œ

      - name: ðŸ§  Generate updated embeddings
        working-directory: tea-diagnosis
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: pnpm run generate:embeddings
        continue-on-error: true  # Embeddingç”Ÿæˆå¤±æ•—ã§ã‚‚ç¶šè¡Œ

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## RAGåŒæœŸçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¨˜äº‹åŒæœŸ" >> $GITHUB_STEP_SUMMARY
          echo "- HealTeaè¨˜äº‹åŒæœŸ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- MarketSupporterAIè¨˜äº‹åŒæœŸ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Embeddingå†ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- è©³ç´°ã¯å„ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ ãƒ­ã‚°ã®ç¢ºèªæ–¹æ³•:" >> $GITHUB_STEP_SUMMARY
          echo "1. ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œãƒšãƒ¼ã‚¸ã‚’é–‹ã" >> $GITHUB_STEP_SUMMARY
          echo "2. ã€ŒðŸ§  Generate updated embeddingsã€ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "3. æˆåŠŸ/å¤±æ•—ã—ãŸè¨˜äº‹ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™" >> $GITHUB_STEP_SUMMARY
