name: ğŸ” Sync RAG Dry Run (HealTea + MarketSupporterAI)

on:
  workflow_dispatch: # âœ… æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆç¢ºå®Ÿã«UIè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
    inputs:
      log_detail:
        description: "ãƒ­ã‚°è©³ç´°ï¼ˆtrueã§è©³ç´°ãƒ­ã‚°ï¼‰"
        required: false
        default: "false"

jobs:
  dryrun:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout tea-diagnosis (main repo)
        uses: actions/checkout@v4

      - name: ğŸ“¥ Clone HealTea Project
        uses: actions/checkout@v4
        with:
          repository: temasamo/healtea-blog
          path: HealTea-Project
          token: ${{ secrets.PAT_TOKEN }}

      - name: ğŸ“¥ Clone Affiliate Project
        uses: actions/checkout@v4
        with:
          repository: temasamo/affiliate-blog
          path: Affiliate-Project
          token: ${{ secrets.PAT_TOKEN }}

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§  Dry Run Sync (No Supabase writes)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸŸ¢ Dry Run é–‹å§‹: HealTea + Affiliate è¨˜äº‹ã‚’è§£æä¸­..."
          
          echo ""
          echo "HealTea ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ:"
          tree HealTea-Project/src/content/blog/health/tea/blendedtea | head -n 20
          echo ""

          echo "Affiliate ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ:"
          tree Affiliate-Project/articles/japanesetea | head -n 20
          echo ""

          echo "ğŸ“Š äºˆå®šåŒæœŸä»¶æ•°ã‚’æ¦‚ç®—ä¸­..."
          healtea_count=$(find HealTea-Project/src/content/blog/health/tea/blendedtea -name '*.md' | wc -l)
          affiliate_count=$(find Affiliate-Project/articles/japanesetea -name '*.md' | wc -l)

          echo "ğŸ“˜ HealTea è¨˜äº‹æ•°: $healtea_count"
          echo "ğŸ“— MarketSupporterAI è¨˜äº‹æ•°: $affiliate_count"

          total=$((healtea_count + affiliate_count))
          echo "âœ… åˆè¨ˆäºˆå®šåŒæœŸä»¶æ•°: $total"

          if [ "${{ github.event.inputs.log_detail }}" = "true" ]; then
            echo ""
            echo "ğŸ§¾ HealTea è¨˜äº‹ãƒªã‚¹ãƒˆï¼ˆå…ˆé ­10ä»¶ï¼‰:"
            find HealTea-Project/src/content/blog/health/tea/blendedtea -name '*.md' | head -n 10
            echo ""
            echo "ğŸ§¾ Affiliate è¨˜äº‹ãƒªã‚¹ãƒˆï¼ˆå…ˆé ­10ä»¶ï¼‰:"
            find Affiliate-Project/articles/japanesetea -name '*.md' | head -n 10
          fi

          echo ""
          echo "ğŸ§© ç¢ºèªçµæœ: OpenAIã‚­ãƒ¼åˆ©ç”¨å¯èƒ½ â†’ âœ… $(if [ -n \"$OPENAI_API_KEY\" ]; then echo 'OK'; else echo 'NG'; fi)"
          echo "ğŸ§© Supabaseã‚­ãƒ¼åˆ©ç”¨å¯å¦ï¼ˆDryRunã§ã¯æœªä½¿ç”¨ï¼‰ â†’ âœ… (çœç•¥)"
          echo ""
          echo "ğŸŒ™ Dry Run å®Œäº†ï¼ Supabaseã¸ã®æ›¸ãè¾¼ã¿ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚"
